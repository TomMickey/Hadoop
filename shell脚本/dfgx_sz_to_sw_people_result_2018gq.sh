#!/bin/bash

hive -e "
	set mapreduce.job.name='深圳省外游-生成明细数据';
	use dfgx_tour_db;
	insert overwrite table dfgx_tour_db.dfgx_sz_to_sw_people_result_2018gq SELECT j.msisdn,j.visit_area_code,j.first_date,j.last_date,j.stay_day,j.age_type,j.sex FROM (SELECT h.msisdn,h.visit_area_code,h.first_date,h.last_date,h.stay_day,nvl(j.age_type,'未知') AS age_type,nvl(j.sex,'未知') AS sex FROM (SELECT g.msisdn,g.visit_area_code,first_date,last_date,datediff(g.last_date,g.first_date) AS stay_day FROM (SELECT f.msisdn,f.visit_area_code,f.start_date,first_value(f.start_date) OVER (partition by f.msisdn,f.visit_area_code,f.code ORDER BY  f.start_date) AS first_date,last_value(f.start_date) over(partition by f.msisdn,f.visit_area_code,f.code ORDER BY  f.start_date rows BETWEEN unbounded preceding AND unbounded following) AS last_date FROM  (SELECT e.msisdn, e.visit_area_code, e.start_date, e.l_row,  e.r_row, (e.l_row-e.r_row) AS code  FROM   (SELECT d.msisdn, d.visit_area_code, d.start_date, d.l_row, row_number() over(partition by d.msisdn, d.visit_area_code ORDER BY  d.start_date) AS r_row FROM    (SELECT c.msisdn, c.visit_area_code, c.start_date, row_number() over(partition by c.msisdn ORDER BY  c.start_date) AS l_row FROM  (SELECT b.msisdn, b.visit_area_code,  b.start_date  FROM   (SELECT a.msisdn, a.roam_type, case  WHEN a.roam_type=6 THEN '国外' WHEN a.roam_type=0 THEN '省内'  WHEN a.roam_type='1' THEN  '省内'  WHEN a.roam_type=8 THEN '省内' ELSE a.visit_area_code  END AS visit_area_code,concat(concat_ws('-',substr(a.start_date,1,4),substr(a.start_date,5,2),substr(a.start_date,7,2)),' ','00:00:00') AS start_date FROM dfgx_tour_db.dfgx_sz_sw_travel_mx_2018gq a) b  GROUP BY  b.msisdn,b.visit_area_code,b.start_date) c) d) e) f) g WHERE g.visit_area_code !='省内' AND g.visit_area_code !='国外'   AND g.start_date >='2018-09-01 00:00:00') h  LEFT JOIN   (SELECT SERIAL_NUMBER, case  WHEN age <=14 THEN  '少年'  WHEN age>=15  AND age<=24 THEN  '青年'  WHEN age>=25  AND age<=44 THEN '壮盛年'  WHEN age>=45  AND age<=64 THEN  '中年'  WHEN age>=65 THEN  '老年'  END AS age_type,case  WHEN sex = ''  OR sex is NULL THEN '未知'  ELSE sex END AS sex FROM dfgx_wo_db.dfgx_user_info) j  ON h.msisdn=j.serial_number) j  GROUP BY  j.msisdn,j.visit_area_code,j.first_date,j.last_date,j.stay_day,j.age_type,j.sex;
"